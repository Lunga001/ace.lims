<tal:comment replace="nothing">
    Print COA for a set of analysisrequests.

    The filename starts with "multi" indicates this report is formatted
    print multiple ARs.
</tal:comment>

<tal:report tal:define="num_ars_per_page python:5;
                        argroup python:view.getAnalysisRequestGroup();
                        arspage python:[argroup[i:i+num_ars_per_page] for i in range(0,len(argroup),num_ars_per_page)];
                        coanr python:view.next_certificate_number();">

  <!-- Address and Lab info, displayed only on first page. -->
  <div id="section-info"
       tal:define="firstar         python:arspage[0][0];
                   analysisrequest python:view.getAnalysisRequest(firstar);
                   portal          analysisrequest/portal;
                   client          python:analysisrequest['client']['obj'];
                   contact         python:analysisrequest['contact']['obj'];
                   sample          python:analysisrequest['sample']['obj'];
                   batch           python:analysisrequest['batch'];
                   laboratory      analysisrequest/laboratory;
                   showqcanalyses  python:view.isQCAnalysesVisible();
                   remarksenabled  python:view.context.bika_setup.getEnableAnalysisRemarks();">

    <table width="100%" cellpadding="0" cellspacing="0">
      <tr>
        <td style="width: 50%">
          <!-- Client -->
          <table>
            <tr>
              <th i18n:translate="" class="label">MME</th>
              <td tal:content="python:client.Title()">To be confirmed</td>
            </tr>
            <tr>
              <th i18n:translate="" class="label">MME ID</th>
              <td tal:content="python:client.id">To be confirmed</td>
            </tr>
            <tr>
              <th i18n:translate="" class="label">Strain</th>
              <td tal:content="analysisrequest/strain">
              </td>
            </tr>
            <tr>
              <th i18n:translate="" class="label">Batch</th>
              <td tal:content="analysisrequest/cultivation_batch"/>
            </tr>
            <tr>
              <th i18n:translate="" class="label">LOT</th>
              <td tal:content="analysisrequest/lot"/>
            </tr>
          </table>
        </td>
        <td style="width: 50%">
          <!-- Laboratory -->
          <table>
            <tr>
              <th i18n:translate="" class="label">
                Laboratory
              </th>
              <td tal:content="laboratory/title"/>
            </tr>
            <tr>
              <th i18n:translate="" class="label">Product
              </th>
              <td tal:content="analysisrequest/product"/>
            </tr>
            <tr>
              <th i18n:translate="" class="label">
                Sampling Date
              </th>
              <td tal:content="analysisrequest/sampling_date"></td>
            </tr>
            <tr>
              <th i18n:translate="" class="label">
                Received Date
              </th>
              <td tal:content="analysisrequest/date_received"></td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </div>

  <tal:page_iter repeat="ars arspage">
    <tal:page tal:define="firstar         python:ars[0];
                          analysisrequest python:view.getAnalysisRequest(firstar);
                          portal          analysisrequest/portal;
                          client          python:analysisrequest['client']['obj'];
                          contact         python:analysisrequest['contact']['obj'];
                          laboratory      analysisrequest/laboratory;
                          showqcanalyses  python:view.isQCAnalysesVisible();
                          remarksenabled  python:view.context.bika_setup.getEnableAnalysisRemarks();
                          ">

      <!-- This element will be displayed on each page within the top margin area. -->
      <div id="section-header" class="page-header">
        <div id='lab-logo'>
          <table style="margin:0;padding:0;width:100%" cellpadding="0" cellspacing="0">
            <tr>
              <td width="34%">
                <a tal:attributes="href laboratory/url">
                  <img tal:attributes="src python:portal['obj'].absolute_url() + '/logo_print.png'"/>
                </a>
              </td>
              <td width="33%" style="text-align:center" id="section-info-heading" i18n:translate="section-info-heading">
                <h1>CERTIFICATE OF ANALYSIS</h1>
              </td>
              <td width="33%" style="text-align:right">
              <div class="page-number">Page
                <span class="page-current-num"></span> of
                <span class="page-total-count"></span></div>
                <p tal:content="string: Report No. ${coanr}"/>
              </td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Analysis Requests table -->
      <tal:def tal:define="transposed python:view.getAnaysisBasedTransposedMatrix(ars);
                           cat_titles python:sorted(transposed.keys());
                           leftcol_width python:50 + divmod(50, len(ars))[1];
                           rightcol_width python:100 - leftcol_width;
                           methodcol_width python:float(leftcol_width)/100*40;
                           servicecol_width python:float(leftcol_width)/100*50;
                           unitcol_width python:leftcol_width-(methodcol_width+servicecol_width);
                           arcol_width python:float(rightcol_width)/len(ars);">

        <!-- AR Group headers -->
        <div class="table ar_table">
            <div class="row">
                <span class="td">
                    <img class="ar-image" 
                        tal:condition="analysisrequest/attachment_src" tal:attributes="src analysisrequest/attachment_src"/>
                </span>
             </div>
        </div>
        <tal:category tal:repeat="cat_title cat_titles">
          <!-- Service details for each result and results for each AR -->
          <div class="table ar_table">
            <div class="row">
              <span class="th" tal:content="cat_title"/>
              <span class="th">Unit</span>
              <tal:ar repeat="ar ars">
                <span class="th"
                      >Result</span>
              </tal:ar>
            </div>

            <tal:cat_analyses tal:repeat="service_title python:sorted(transposed[cat_title].keys())">
              <div class="row" tal:condition="python:service_title != '_data'" >
                <span class="td service_title">
                  <span tal:content="service_title"/>
                  <img tal:attributes='src python:portal["url"]+"/++resource++bika.lims.images/accredited.png";'
                       tal:condition="python:transposed[cat_title][service_title]['accredited']"
                       class="accredited-ico"/>
                </span>

                <span class="td unit"
                      tal:attributes="style string:width:${unitcol_width}%"
                      tal:content="python:transposed[cat_title][service_title]['service'].getUnit()"></span>
                <tal:ar repeat="ar ars">
                  <span class="td result"
                        tal:content="structure python:transposed[cat_title][service_title]['ars'].get(ar.id,'')"/>
                </tal:ar>
              </div>
            </tal:cat_analyses>
            <tal:cat_data tal:repeat="data python:sorted(transposed[cat_title].keys())">
              <div tal:condition="python: data=='_data' and len(transposed[cat_title][data]['footnotes']) > 0"
                  tal:content="python:transposed[cat_title][data]['footnotes']">
              </div>
            </tal:cat_data>
          </div>
        </tal:category>

      </tal:def>

      <!--
           Page footer
           A div element with the class "page-footer" will be placed in the
           bottom of the report, within the bottom margin area. This element
           will be displayed on each page.

           Page numbering
           For the number of page, use the "page-current-num" class.
           For the total count, use the "page-total-count" class.
         -->
        <!--
        <div style="width:41%; float: right; margin-top:5px">
            <hr style="width:100%"/>
            <div style="width:50%; float:left"></div>
            <div style="float:right">03/02/2017</div>
            <div style="clear:both; font-size:8px; text-align:right">
                This signature indicate the above material has been reviewed and verified
            </div>
              
        </div>
        -->
      <div class='page-footer' style="height:60px">
        <div class="lab-manager">
            <hr style="width:100%"/>
            <div class="lab-manager-name" tal:content="laboratory/lab_manager"></div>
            <div class="lab-manager-date" tal:content="laboratory/today"></div>
            <div class="lab-manager-terms">
                This signature indicate the above material has been reviewed and verified
            </div>
              
        </div>
        <table style="width:100%; text-align:center">
         <tr>
            <td tal:content="laboratory/phone"/>
            <td id="" tal:content='structure laboratory/address'></td>
            <td>
              <a tal:content="laboratory/email"
                 tal:attributes="url python:'mailto:%s' % laboratory['email']"/>
            </td>
         </tr>
        </table>
      </div>

      <!--
           Manual break ("manual-page-break" css class)
           We want to report to be splitted by the max number of ARs per page.

           Restart page count ("restart-page-count" css class)
           We want the number of pages to restart after the current page
         -->
      <div class='manual-page-break'></div>
    </tal:page>
  </tal:page_iter>
</tal:report>
